{%- from "nginx_macros.conf" import location_block, server_block_http, server_block_https -%}

server_names_hash_bucket_size 64;

upstream frappe {
    server 127.0.0.1:8000 fail_timeout=0;
}

upstream socketio-server {
    server 127.0.0.1:3000 fail_timeout=0;
}

{% for site in sites -%}

	{% if site.port -%}
		{{ server_block_http(site, sites_dir=sites_dir, http_timeout=http_timeout) }}
	{%- endif %}

	{% if site.ssl_certificate_key and site.ssl_certificate -%}
		{{ server_block_https(site, sites_dir=sites_dir, http_timeout=http_timeout) }}
	{%- endif %}

{%- endfor %}

{% if default_site -%}
	{{ server_block_http(default_site, default=True, server_name="frappe_default_site", sites_dir=sites_dir, http_timeout=http_timeout) }}
{%- endif %}

{% if dns_multitenant and sites -%}
	{{ server_block_http(None, default=False, sites=sites, sites_dir=sites_dir, http_timeout=http_timeout, dns_multitenant=True) }}
{%- endif %}

